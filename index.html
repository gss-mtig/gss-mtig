<!DOCTYPE html>
<html>
<head>
    <title>Servicio de Bicing realtime VectorTiles</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script type="text/javascript">
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'https://geoserveis.icgc.cat/contextmaps/icgc.json',
            center: [2.1777, 41.3887],
            zoom: 13,
            maxZoom: 14,
            hash: true,
        });
		
		map.on("load", function() {
			
			//agregamos la fuente de datos al mapa
			map.addSource('bicing-source', {
				type: 'geojson',
				data: 'http://localhost:3000/bicingjson/'
			});

			//agregamos la capa con su estilo al mapa
			map.addLayer({
				"id": "bicing",
				"type": "circle",
				"source": "bicing-source",
				"paint": {
					"circle-radius": [
						"interpolate",
						["linear"],
						["to-number", ['get','slots']],
						0,
						5,
						33,
						15
					],
					"circle-color": [
						"interpolate",
						["linear"],
						["to-number", ["get", "bikes"]],
						0,
						"hsl(0, 88%, 55%)",
						37,
						"hsl(108, 93%, 59%)"
					],
					"circle-opacity": 0.86
				},
			});

			window.setInterval(function() {
    		    map.getSource('bicing-source').setData('http://localhost:3000/bicingjson/');
			}, 30000);
		});

		map.on('click', function(e) {
			var features = map.queryRenderedFeatures(e.point, { layers: ['bicing'] });

			// if the features have no info, return nothing
			if (!features.length) {
				return;
			}

			var feature = features[0];

			// Populate the popup and set its coordinates
			// based on the feature found
			var popup = new mapboxgl.Popup()
			.setLngLat(feature.geometry.coordinates)
			.setHTML('<div id=\'popup\' class=\'popup\' style=\'z-index: 10;\'> <h5> ' + feature.properties.id + ' </h5>' +
			'<ul class=\'list-group\'>' +
			'<li class=\'list-group-item\'> ' + feature.properties.streetName + ' </li>' +
			'<li class=\'list-group-item\'> Bikes: ' + feature.properties.bikes + ' </li>' +
			'<li class=\'list-group-item\'> slots: ' + feature.properties.slots + ' </li></ul></div>')
			.addTo(map);
		});

		// Use the same approach as above to indicate that the symbols are clickable
		// by changing the cursor style to 'pointer'
		map.on('mousemove', function(e) {
			var features = map.queryRenderedFeatures(e.point, { layers: ['bicing'] });
			map.getCanvas().style.cursor = features.length ? 'pointer' : '';
		});

    </script>
</body>
</html>